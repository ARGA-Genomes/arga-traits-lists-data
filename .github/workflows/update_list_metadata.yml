name: Update Species List Metadata (One-Off)

on:
  workflow_dispatch:
    inputs:
      speciesListID:
        description: 'ID of the species list to update'
        required: true
        default: '67b51f358a0f582bd7ef9d73'
      licenseURL:
        description: 'License URL to apply'
        required: true
        default: 'https://creativecommons.org/licenses/by/4.0/'

jobs:
  update-metadata:
    runs-on: ubuntu-latest
    steps:
      - name: Init Node project
        run: npm init -y

      - name: Install axios
        run: npm install axios

      - name: Update species list license
        env:
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          LIST_ID: ${{ github.event.inputs.speciesListID }}
          LICENSE: ${{ github.event.inputs.licenseURL }}
        run: |
          node <<'EOF'
          const axios = require('axios');
          
          const token = process.env.ACCESS_TOKEN;
          const listId = process.env.LIST_ID;
          const license = process.env.LICENSE;
          const api = "https://lists-ws.test.ala.org.au/graphql";

          const mutation = `
            mutation {
              updateSpeciesList(inputSpeciesList: {
                id: "${listId}",
                license: "${license}"
              }) {
                id
                license
              }
            }
          `;

          (async () => {
            try {
              const res = await axios.post(api, { query: mutation }, {
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                }
              });
              console.log("✅ License updated to:", res.data.data.updateSpeciesList.license);
            } catch (err) {
              console.error("❌ Error:", err.response?.data || err.message);
              process.exit(1);
            }
          })();
          EOF
