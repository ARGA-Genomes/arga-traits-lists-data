name: Push CSV to ALA Lists

on:
  push:
    branches:
      - main
    paths:
      - 'imported_GoogleSheets/*.csv'  # triggers only when CSV files are changed

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        
      - name: Get list of changed CSV files
        id: get_files
        run: |
          echo "Listing CSV files changed in this push:"
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} \
            | grep '^imported_GoogleSheets/.*\.csv$' || true > changed_csvs.txt

          cat changed_csvs.txt

      - name: Loop through and print contents
        run: |
          while IFS= read -r file; do
            echo "==== $file ===="
            head -n 10 "$file"
          done < changed_csvs.txt

      - name: Load test ALA token
        run: |
          echo "Using static ALA access token for testing."
          echo "ACCESS_TOKEN=${{ secrets.ALA_ACCESS_TOKEN }}" >> $GITHUB_ENV
      
      - name: Send test GraphQL mutation to ALA Lists
        run: |
          curl -s -X POST "https://lists-ws.test.ala.org.au/graphql" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -d '{"query":"mutation create($createItem: InputSpeciesListItem) { newItem: addSpeciesListItem(inputSpeciesListItem: $createItem) { id scientificName } }","variables":{"createItem":{"speciesListID":"67bbbd07a9349d409385d6de","scientificName":"Testus venomosa","classification":{"taxonConceptID":"urn:lsid:biodiversity.org.au:afd.taxon:1234abcd"}}}}'
